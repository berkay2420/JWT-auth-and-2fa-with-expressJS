<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2 id="welcomeMessage">Welcome!</h2>
    <h3>Your Games:</h3>
    <ul id="gameList"></ul>

    <button id="addGameBtn">Add New Game</button>

    <div id="addGameForm" style="display:none; margin-top:10px;">
      <input type="text" id="newGameName" placeholder="Game Name" required />
      <input type="text" id="newGamePrice" placeholder="Game Price" required />

      <button id="submitGameBtn">Submit Game</button>

      <button id="verifyEmailBtn" style="background-color: orange;">Verify your email!</button>
    </div>
    
    <form id="otpForm" style="display:none; margin-top:20px;">
      <input type="text" id="otp" placeholder="Enter OTP" required />
      <button type="submit">Verify OTP</button>
    </form>

    <button id="logoutBtn">Logout</button>
  </div>

  <script>
    let currentUserId;
    let currentUser;

    function logout() {
      localStorage.removeItem("userId");
      localStorage.removeItem("accessToken");
      localStorage.removeItem("refreshToken");
      window.location.href = "index.html";
    }

    async function handleTokenRefresh() {
      const refreshToken = localStorage.getItem("refreshToken");
      if (!refreshToken) {
        logout();
        throw new Error("No refresh token available. Logging out.");
      }

      try {
        const res = await fetch("http://localhost:3000/auth/refresh-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: refreshToken })
        });

        const data = await res.json();

        if (res.ok && data.status === "SUCCESS") {
          const newAccessToken = data.data.accessToken;
          localStorage.setItem("accessToken", newAccessToken);
          return newAccessToken;
        } else {
          logout();
          throw new Error(data.message || "Session expired. Please log in again.");
        }
      } catch (error) {
        logout();
        throw new Error("Session refresh failed. Logging out.");
      }
    }

    async function secureFetch(url, options = {}) {
      let token = localStorage.getItem("accessToken");

      if (!options.headers) {
        options.headers = {};
      }

      if (token) {
        options.headers["Authorization"] = `Bearer ${token}`;
      }

      let res = await fetch(url, options);

      if (res.status === 401) {
        try {
          const newAccessToken = await handleTokenRefresh();
          options.headers["Authorization"] = `Bearer ${newAccessToken}`;
          res = await fetch(url, options);
        } catch (refreshError) {
          throw refreshError;
        }
      }

      return res;
    }

    async function fetchUserData() {
      const userId = localStorage.getItem("userId");
      let url = "http://localhost:3000/api/user";
      let options = { method: "GET" };

      if (!localStorage.getItem("accessToken") && userId) {
        url += `?userId=${userId}`;
      } else if (!localStorage.getItem("accessToken") && !userId) {
        window.location.href = "index.html";
        return;
      }

      try {
        const res = await secureFetch(url, options);
        const data = await res.json();

        if (!res.ok) {
          alert(data.message || "Failed to fetch user");
          return;
        }

        currentUser = data.user;
        document.getElementById("welcomeMessage").textContent = `Welcome, ${data.user.name}!`;

        const list = document.getElementById("gameList");
        list.innerHTML = "";
        data.user.games.forEach(game => {
          const li = document.createElement("li");
          li.textContent = `${game.name} - ${game.price}â‚º`;
          list.appendChild(li);
        });

        show2FAQuestion(data.user);
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    }

    fetchUserData();

    document.getElementById("verifyEmailBtn").addEventListener("click", async () => {
      const userId = localStorage.getItem("userId");
      try {
        const res = await fetch("http://localhost:3000/auth/verify-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ userId }),
        });

        const data = await res.json();
        if (data.status === "PENDING") {
          alert("OTP sent to your email. Please check and enter it below.");
          currentUserId = data.data.userId;
          document.getElementById("addGameForm").style.display = "none";
          document.getElementById("otpForm").style.display = "block";
        } else {
          alert(data.message || "Failed to send verification email.");
        }
      } catch (error) {
        alert("Error: " + error.message);
      }
    });

    document.getElementById("otpForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const otp = document.getElementById("otp").value.trim();

      if (!currentUserId) {
        alert("User ID not found. Please try sending the email again.");
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/auth/verify-emailOTP", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUserId, otp })
        });

        const data = await res.json();
        if (data.status === "SUCCESS" && data.data && data.data.accessToken) {
          alert("Email verified successfully!");

          localStorage.setItem("accessToken", data.data.accessToken);
          localStorage.setItem("refreshToken", data.data.refreshToken);
          localStorage.removeItem("userId");

          document.getElementById("otpForm").style.display = "none";
          document.getElementById("otp").value = "";
          setTimeout(() => {
            window.location.reload();
          }, 300);
        } else {
          alert(data.message || "OTP verification failed.");
        }
      } catch (error) {
        alert("An error occurred during OTP verification: " + error.message);
      }
    });
    
    function show2FAQuestion(user) {
      const token = localStorage.getItem("accessToken");
      
      if (token && user.verified && !user.enable2fa) {
        const container = document.querySelector(".container");

        const questionDiv = document.createElement("div");
        questionDiv.id = "twoFAQuestion";
        questionDiv.style.marginTop = "20px";
        questionDiv.innerHTML = `
          <p>Would you like to enable 2FA?</p>
          <button id="enable2FA">Yes</button>
          <button id="skip2FA">No</button>
        `;

        container.appendChild(questionDiv);

        document.getElementById("enable2FA").addEventListener("click", async () => {
          try {
            const options = { method: "POST" };
            const res = await secureFetch("http://localhost:3000/auth/enable-2fa", options);
            const data = await res.json();

            if (res.ok && data.status === "SUCCESS") {
              localStorage.setItem("accessToken", data.data.accessToken);
              localStorage.setItem("refreshToken", data.data.refreshToken);
              alert("2FA successfully enabled!");
            } else {
              alert(data.message || "Failed to enable 2FA");
            }
          } catch (err) {
            alert("Error: " + err.message);
          } finally {
            questionDiv.remove();
          }
        });

        document.getElementById("skip2FA").addEventListener("click", () => {
          questionDiv.remove();
        });
      }
    }

    document.getElementById("addGameBtn").addEventListener("click", () => {
      const form = document.getElementById("addGameForm");
      form.style.display = form.style.display === "none" ? "block" : "none";
    });

    document.getElementById("submitGameBtn").addEventListener("click", async () => {
      const name = document.getElementById("newGameName").value;
      const price = parseInt(document.getElementById("newGamePrice").value);

      if (!name || !price) {
        alert("Please enter both game name and price.");
        return;
      }

      const options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ game: [{ name, price }] }),
      };

      try {
        const res = await secureFetch("http://localhost:3000/api/addNewGame", options);
        const data = await res.json();

        if (res.ok) {
          alert("Game added successfully!");
          document.getElementById("newGameName").value = "";
          document.getElementById("newGamePrice").value = "";
          document.getElementById("addGameForm").style.display = "none";
          fetchUserData();
        } else {
          alert(data.message || "Failed to add game");
        }
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    });
    
    document.getElementById("logoutBtn").addEventListener("click", logout);
  </script>
</body>
</html>
